<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html><head>
<script type="text/javascript">

alert("Loaded Global.html");

//safari.application.addEventListener("validate", validateHandler, false);
safari.application.addEventListener("menu", menuHandler, false); // Just before menu is displayed
safari.application.addEventListener("command", cmdHandler, false); // Clicked on menu item
safari.application.addEventListener("message", msgHandler, false); // Received list of feeds from web page

// Associative array used to store menus for each open tab. 
// afeeds['url']=[['fname','furl'],['fname','furl'],â€¦]]
var afeeds = new Object();

/* Utilities */

function getToolbarBtnByID(id){
	var itemArray = safari.extension.toolbarItems;
		for (var i = 0; i < itemArray.length; ++i) {
    		var item = itemArray[i];
		    if (item.identifier == id)
				return item;
		}
	return null;
}

function getMenuByID(id){
	var itemArray = safari.extension.menus;
		for (var i = 0; i < itemArray.length; ++i) {
    		var item = itemArray[i];
		    if (item.identifier == id)
				return item;
		}
	return null;
}

/* Safari Extension handlers */

function cmdHandler(event){
   	/*if (event.command == "feedMenuBtnClicked"){
   		safari.application.activeBrowserWindow.activeTab.page.dispatchMessage("toolbarbutton", null);
   	}
	else*/
	{
		feedURL = event.command.split('-')[1];
		alert(feedURL);
	}
}

function validateHandler(event){
	console.log("Validate - "+event.target.identifier);
	
	/*
	if (event.target.identifier == "feedMenuBtn"){
		if (event.target.menu.menuItems.length == 0)
			event.target.disabled = true;
		else
			event.target.disabled = false;
	}
	*/
	
}

function menuHandler(event){
		
	var btn = getToolbarBtnByID('feedMenuBtn');
	var feedMenu = getMenuByID('feedMenu');
	var feedsToAdd = afeeds[safari.application.activeBrowserWindow.activeTab.url];

	// Must hide menu before making any dynamic changes
	feedMenu.visible=false;
	
	// Clear the existing menu
	var l = feedMenu.menuItems.length;
	if (l>0)
		for (var i=0; i<l; i++)
			feedMenu.removeMenuItem(0); // or remove item 0?
	
	// Add the feeds (or the "No feeds found" menu item
	btn.menu = feedMenu;		
	
	for (i=0; i < feedsToAdd.length; i++)
			feedMenu.appendMenuItem('feed'+i,feedsToAdd[i][0],'location-'+feedsToAdd[i][1]);
			
	console.log(afeeds);
}

function msgHandler(event){

   	if (event.name == "foundFeeds"){
   		
		var f = event.message[0];
		if (f.length == 0)
			f = [["No feeds found on this page","#"]];
		
		afeeds[event.target.url] = f;
   		
   	}
}
</script></head>
<body></body></html>