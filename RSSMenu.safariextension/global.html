<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<!-- Global Page for Safari RSS Feed Extension
     Â© 2012 Calum Benson
     Licence: None - public domain -->

<html><head>
<script type="text/javascript">

// Associative array used to store menus for each open tab. 
// afeeds['url']=[['fname','furl'],['fname','furl'],...]]
var afeeds = new Object();

safari.application.addEventListener("validate", validateHandler, false);
safari.application.addEventListener("menu", menuHandler, false); // Just before menu is displayed
safari.application.addEventListener("command", cmdHandler, false); // Clicked on menu item
safari.application.addEventListener("message", msgHandler, false); // Received list of feeds from web page
safari.extension.settings.addEventListener("change", settingsChangeHandler, false); // Settings changed in prefs window

// These two only work in Safari 5.1 and later. They don't bubble, hence second param=true.
safari.application.addEventListener("close", deleteMenuHandler, true);
safari.application.addEventListener("beforeNavigate", deleteMenuHandler, true);

/* Utilities */

function getToolbarBtnByID(id){
// Return the toolbar object with the specified id.
	var itemArray = safari.extension.toolbarItems;
		for (var i = 0; i < itemArray.length; ++i) {
    		var item = itemArray[i];
		    if (item.identifier == id)
				return item;
		}
	return null;
}

function getMenuByID(id){
// Return the menu object with the specified id.
	var itemArray = safari.extension.menus;
		for (var i = 0; i < itemArray.length; ++i) {
    		var item = itemArray[i];
		    if (item.identifier == id)
				return item;
		}
	return null;
}

function urlOpenInBrowser(url){
// Return true if url is open in any tab in any window,
// otherwise false.

	var w = safari.application.browserWindows;
	
	for (var i=0; i<w.length; w++){
		var t = w[i].tabs;		
		for (i=0; i < t.length; i++){
		
			if (t[i].url === url){
				return true;		
			}
		}
	}
	return false;
}


/* Safari Extension message handlers */

function cmdHandler(event){
// Called when user clicks a toolbar button or menu item.

	if (event.command.substr(0,4)=="http"){
		// Menu item clicked.
		
		switch (safari.extension.settings.feed_action){
		
			case 'google':
			// Open feed URL in a new tab in Google Reader for now.
				feedURL = 'http://www.google.com/reader/view/feed/'+encodeURIComponent(event.command);
				safari.application.activeBrowserWindow.openTab().url=feedURL;
				break;
				
			case 'defaultapp':
			case 'alwaysask':				
				// Open feed in default reader application, or ask the user
				safari.application.activeBrowserWindow.activeTab.page.dispatchMessage
					("showFeedPopup",[event.command, // We previously set the command to the URL of the feed
					safari.extension.settings.feed_action, // Which app to use to open the feed (or 'ask')
					safari.extension.settings.banner_timeout * 1000]); // Only used if app to use is 'default app'
				break;
				
			default:
				console.log('Unrecognised feed action: '+safari.extension.settings.feed_action);
				break;
		}
	}
}

function validateHandler(event){
// Called automatically when an extension component needs to revalidate itself, e.g. when tab re-gains focus.
	
	var thisUrl = safari.application.activeBrowserWindow.activeTab.url;
	
	if (event.target.identifier == "feedMenuBtn"){

		//Update button enabled/disabled state, badge count and badge visibility.
		var btn = event.target;
	
		if (thisUrl in afeeds){
			// We have already scanned this page
			
			if (afeeds[thisUrl].length >0){
				// Set badge to number of feeds on page, if user preference dictates
				btn.disabled = false;
				if (safari.extension.settings.show_badge == true)
					btn.badge = afeeds[thisUrl].length;
			}
			else{
				// No feeds found on this page
				btn.disabled = true;
				btn.badge = 0;
			}
		}
		else{
			// Tab contains blank page
			btn.disabled = true;
			btn.badge = 0;
		}
	}
}

function menuHandler(event){
// Called when the toolbar button menu is about to be displayed.
		
	var btn = getToolbarBtnByID('feedMenuBtn');
	var feedMenu = getMenuByID('feedMenu');
	var feedsToAdd = afeeds[safari.application.activeBrowserWindow.activeTab.url];

	// Must hide menu before making any dynamic changes
	feedMenu.visible=false;
	
	// Clear the existing menu
	var l = feedMenu.menuItems.length;
	if (l>0)
		for (var i=0; i<l; i++)
			feedMenu.removeMenuItem(0);
	
	// Add the new feeds to the menu, if any
	btn.menu = feedMenu;			
	if (feedsToAdd.length > 0)
		for (i=0; i < feedsToAdd.length; i++)
			feedMenu.appendMenuItem('feed'+i,feedsToAdd[i][0],feedsToAdd[i][1]);
			
	// Clear badge when button clicked
	btn.badge = 0;
}

function msgHandler(event){
// Called when the pageEndScript has something to tell us.

	switch (event.name){
   	
	   	case "foundFeeds":
	   		// event.message = array of [feed_title, feed_url] found on the page.
			afeeds[event.target.url] = event.message;
			break;
	   	
	   	case "openFeedInTab":
	   		// Couldn't use iframe method to load feed in external app, so need to do it in a new tab
	   		var url = event.message;
	   		safari.application.activeBrowserWindow.openTab('background').url = url;
	   		// Close the tab again after a short delay
	   		var closetab = function(){
	   			var t = safari.application.activeBrowserWindow.tabs;
	   			t[(t.length)-1].close();
	   		}
	   		setTimeout(closetab,3000);
	   		break;
	}
}

function deleteMenuHandler(event){
// Called when a close or beforeNavigate event is received.
// Deletes afeeds[event.target.url], if that url no longer open in any tab.

	var url = event.target.url;
	
	// Check after a short delay to give the tab time to close first,
	// if it's going to -- otherwise the urlOpenInBrowser call will
	// return true as the tab hasn't closed yet.
	
	setTimeout(function(){
	
		if (urlOpenInBrowser(url) != true){		
			if (url in afeeds)
				delete afeeds[url];
			//var btn = getToolbarBtnByID('feedMenuBtn');
			//btn.disabled = true;
			//btn.badge = 0;
		}
		
	},500);
}

function settingsChangeHandler(event){
// Called when extension settings are changed in the Safari Preferences dialog.

	switch (event.key){

		case "feed_action":
			// If 'default action' setting is changed, we inform the injected script so it can
			// hide the popup banner if it's visible at the time.
			safari.application.activeBrowserWindow.activeTab.page.dispatchMessage
					("feedActionChanged", 0);
			break;
	
		case "show_badge":
			// If the show_badge setting is changed, show or hide the badge immediately.
			var btn = getToolbarBtnByID('feedMenuBtn');
			var thisUrl = safari.application.activeBrowserWindow.activeTab.url;
			
			if (safari.extension.settings.show_badge == true){
				btn.badge = afeeds[thisUrl].length;
			}
			else{
				btn.badge = 0;
			}
			break;
	}
}

</script></head>
<body></body></html>